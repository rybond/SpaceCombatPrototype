[gd_scene load_steps=5 format=3 uid="uid://khxciokpnn4i"]

[ext_resource type="PackedScene" uid="uid://tuarrcu60k8f" path="res://scenes/ships/ship.tscn" id="1_1ars5"]
[ext_resource type="PackedScene" uid="uid://dohd8ju5jy6yr" path="res://asteroids/asteroid_jumbo.tscn" id="2_34y1k"]
[ext_resource type="PackedScene" uid="uid://ct3edo70w38iu" path="res://projectiles/Projectile.tscn" id="2_q0diq"]

[sub_resource type="GDScript" id="GDScript_drjwc"]
script/source = "extends Node2D

const STAR_COLORS = [
	Color(1, 1, 1),
	Color(0.8, 0.85, 1.0),
	Color(0.6, 0.7, 1.0),
	Color(1.0, 0.95, 0.8),
]

var stars = []
var active_asteroids: int = 0

@export var jumbo_scene: PackedScene
@export var initial_jumbo_count: int = 5

func _ready():
	RenderingServer.set_default_clear_color(Color.BLACK)
	get_viewport().size_changed.connect(_on_viewport_size_changed)
	_generate_stars()
	spawn_initial_wave()

func _generate_stars():
	stars.clear()
	var screen_size = get_viewport_rect().size
	var area = screen_size.x * screen_size.y
	var count = int(area / 8000.0)
	for i in range(count):
		stars.append({
			\"pos\": Vector2(randf() * screen_size.x, randf() * screen_size.y),
			\"color\": STAR_COLORS[randi() % STAR_COLORS.size()],
			\"size\": randf_range(0.5, 2.0)
		})
	queue_redraw()

func _on_viewport_size_changed():
	_generate_stars()

func _draw():
	for star in stars:
		draw_circle(star.pos, star.size, star.color)

func spawn_initial_wave():
	for i in range(initial_jumbo_count):
		spawn_jumbo()

func spawn_jumbo():
	if jumbo_scene == null:
		return
	var asteroid = jumbo_scene.instantiate()
	var screen_size = get_viewport_rect().size

	# Spawn on a random edge
	var edge = randi() % 4
	var spawn_pos = Vector2.ZERO
	match edge:
		0: spawn_pos = Vector2(randf_range(0, screen_size.x), 0)
		1: spawn_pos = Vector2(randf_range(0, screen_size.x), screen_size.y)
		2: spawn_pos = Vector2(0, randf_range(0, screen_size.y))
		3: spawn_pos = Vector2(screen_size.x, randf_range(0, screen_size.y))

	asteroid.position = spawn_pos
	add_child(asteroid)
	_track_asteroid(asteroid)

func _track_asteroid(asteroid: Node):
	active_asteroids += 1
	asteroid.destroyed.connect(_on_asteroid_destroyed)

	# Also track any children it spawns
	asteroid.destroyed.connect(func():
		# Children are added to current_scene in asteroid_base.gd
		# We need to track them — so we connect after a short delay
		# to let split() run first
		await get_tree().process_frame
		for child in get_children():
			if child is AsteroidBase and not child.destroyed.is_connected(_on_asteroid_destroyed):
				_track_asteroid(child)
	)

func _on_asteroid_destroyed():
	active_asteroids -= 1
	if active_asteroids <= 0:
		# All asteroids cleared — spawn one new jumbo
		await get_tree().create_timer(1.5).timeout
		spawn_jumbo()
"

[node name="Arena" type="Node2D"]
script = SubResource("GDScript_drjwc")
jumbo_scene = ExtResource("2_34y1k")

[node name="PlayerShip" parent="." instance=ExtResource("1_1ars5")]
position = Vector2(300, 400)
projectile_scene = ExtResource("2_q0diq")
